def packageName = "app-devops-package-cicd.war"
def artifactname = "app-devops-artifact-cicd.jar"
def version = "1.${BUILD_NUMBER}"
def semanticVersion = "1.${BUILD_NUMBER}.0"
def repoName = "2giridharj/ServiceNow-DevOps-Change-Sample" // Ensure after forking update the repoName accrodingly.
def changeRequestNumber = null

pipeline {
	agent any
	
	tools {
		maven 'Maven'
	}

	environment {
		SCANNER_HOME = tool 'sonarScanner'
		VERACODE_APPLICATION_NAME = 'ServiceNow DevOps App#1' //Ensure you update the correct Application name
		VERACODE_SCANNER_NAME = 'Veracode'
	} 

	stages {
		stage('Build') {
			steps {
				sh 'mvn -B -DskipTests clean compile'
			}
		}

		stage('Test') {
			steps {
			  	sh 'mvn test'
				sleep(5);
			}
			post {
				always {
					junit "**/target/surefire-reports/*.xml"
				}
			}
		}

		stage('Register Artifact') {
			steps {
				snDevOpsArtifact(artifactsPayload: """
				{
				"artifacts":
				[
				    {
				        "name": "${artifactname}",
				        "version": "${version}",
				        "semanticVersion": "${semanticVersion}",
				        "repositoryName": "${repoName}"
				    }
				],
				"branchName": "main"
				}""")
			}     
		}

		stage('Sonar Scan') {
			steps {
				sonarSummaries()
			}
		}

		stage('CheckmarxOne Security Scan') {
			steps {
				snDevOpsSecurityResult securityResultAttributes: '{"scanner": "Checkmarx One", "projectName": "DemoProject", "projectId": "75acb348-c054-4ab3-807d-e17e92a923ab", "scanId": "2bb9e016-3669-488c-8341-ffa4831221f3", "securityToolId": "fd0a44e0c3293510a653f92f050131c6"}'
				// scanner: Scanning tool and is required e.g. Checkmarx One.
				// projectName/projectId: Name/Id of your Checkmarx One project and is required. This attribute is applicable only for Checkmarx One.
				// scanId: Checkmarx One scan id and is optional. This attribute is applicable only for Checkmarx One.
				// securityToolId: Security tool onboarded in ServiceNow (sys_id of the onboarded security tool) and is optional.
			}
		}
		stage('CheckmarxSAST Security Scan') {
			steps {
				snDevOpsSecurityResult securityResultAttributes: '{"scanner": "Checkmarx SAST", "projectId": "1076", "securityToolId": "5fdb19e5c3f1f110cb77e74bb001317c"}'
				// scanner: Scanning tool and is required e.g. Checkmarx SAST.
				// projectId: Id of your Checkmarx SAST project and is required. This attribute is applicable only for Checkmarx SAST.
				// securityToolId: Security tool onboarded in ServiceNow (sys_id of the onboarded security tool) and is optional.
			}
		}
		/*
		stage('Veracode Security Scan') {
			steps {
				snDevOpsSecurityResult securityResultAttributes: '{"scanner": "Veracode", "applicationName": "VeraDemo10", "securityToolId": "0248c4acc3e53510a653f92f0501316e"}'
			}
		}
		*/
		stage('Register Package') {
			steps {
				snDevOpsPackage(
				name: "${packageName}",
				artifactsPayload: """
				{
				    "artifacts":
				    [
				        {
				            "name": "${artifactname}",
				            "version": "${version}",
				            "semanticVersion": "${semanticVersion}",
				            "repositoryName": "${repoName}"
				        }
				    ],
				    "branchName": "main"
				}""")
			}
		}
		  
		stage('Change') {
			steps {
			    snDevOpsChange(changeRequestDetails: '''
			    {
			    "attributes": {
					"requested_by": {
						"name": "DevOps System"
					}, //requested_by with name.
					//You can provide requested_by with sys_id. Example: "requested_by": "62826bf03710200044e0bfc8bcbe5df1", 
					"assignment_group": {
						"name": "Change Management"
					}, //assignment_group with name.
					//You can provide assignment_group with sys_id. Example: "assignment_group": "5f721d93c0a8010e015533746de18bf9",
					"priority": "2",
					"comments": "This is a sample pipeline script to be added in your change step",
					"work_notes": "Update this to work_notes",
					"start_date": "2022-01-05 11:59:59", //This is the planned start date.
					"end_date": "2022-01-08 11:59:59" // This is the planned end date.
				}
			    }''')
			    echo 'Getting change number from the same stage as change creation...'
			    changeRequestNumber = snDevOpsGetChangeNumber(changeDetails: """{ "pipeline_name": "Rama scripted folder/fScripted pipeline", "build_number": "${BUILD_NUMBER}", "stage_name": "Change", "branch_name": "main"}""")
			    echo 'Updating change number from the same stage as change creation...'
			    snDevOpsUpdateChangeInfo(changeRequestDetails: """{ "short_description": "Test description", "priority": "1", "start_date": "2021-02-05 08:00:00", "end_date": "2022-04-05 08:00:00", "justification": "test justification", "description": "test description", "cab_required": true, "comments": "This update for work notes is from jenkins file", "work_notes": "test work notes", "assignment_group": "a715cd759f2002002920bde8132e7018"}""", changeRequestNumber: """${changeRequestNumber}""")
			}
		}
/*
		stage('Get Change') {
			steps {
			    sleep 100
			    echo 'Getting change number from a different stage as change creation...'
			    changeRequestNumber = snDevOpsGetChangeNumber changeDetails: '{ "pipeline_name": "Rama scripted folder/fScripted pipeline", "build_number": "${BUILD_NUMBER}", "stage_name": "Change", "branch_name": "main"}'
			    echo "changeRequestNumber in 'Get Change' is => ${changeRequestNumber}"
			}
		}

		stage('Update Change') {
			steps {
			    echo "changeRequestNumber in 'Update Change' is => ${changeRequestNumber}"
			    echo 'Updating change number from a different stage as change creation...'
			    snDevOpsUpdateChangeInfo(changeRequestDetails: '{"state":"3", "close_code":"successful", "close_notes":"close_notes updated in Update Change stage"}', changeRequestNumber: '${changeRequestNumber}')
			}
		}
*/
		stage('Deploy') {
			steps {
				echo "Deploying the change..."
			}
		}
	}
}

def sonarSummaries() {
	withSonarQubeEnv(installationName: 'ramasonarcloud'){
		sh 'mvn clean verify sonar:sonar \
		    -Dsonar.login=1926d793f92181dd0ac406335d4d4bea392a3023 \
		    -Dsonar.host.url=https://sonarcloud.io \
		    -Dsonar.organization=pramaraju96 \
		    -Dsonar.projectKey=pramaraju96_DevOps-Test'
    }
}
